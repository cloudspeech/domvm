<!doctype html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<title>domvm patch</title>
	<style>
		#perf {
			position: fixed;
			opacity: 0.9;
			right: 0;
			bottom: 0;
		}

		td {
			min-width: 25px;
		}
		.high {
			color: red;
		}
		.low {
			color: blue;
		}
	</style>
</head>
<body>
	Here's a 100x100 (10,000 cell) table of random ints. The blue/red threshold is 50.
	<button onclick="requestAnimationFrame(go);">GO!</button>

	<div id="perf"></div>

	<script src="../../../dist/domvm.min.js"></script>
<!--<script src="../../lib/dominstr.js"></script>-->
	<script src="profiler.js"></script>

	<script>
	//	domvm.config({useRaf: false});

		var rows = 100;
		var cols = 100;
		var mutations = 0.03;

		// ------ slider code -----
		var sliderContainer = document.createElement('div');
		sliderContainer.style.display = 'flex';
		var slider = document.createElement('input');
		slider.type = 'range';
		slider.style.width = '100%';
		slider.style.margin = '5px';
		slider.value = mutations * 100;
		var text = document.createElement('label');
		text.textContent = 'mutations : ' + (mutations * 100).toFixed(0) + '%';

		slider.addEventListener('change', function(e) {
		  mutations = /** @type {!HTMLInputElement} */(e.target).value / 100;
		  text.textContent = 'mutations : ' + (mutations * 100).toFixed(0) + '%';
		});
		sliderContainer.appendChild(text);
		sliderContainer.appendChild(slider);
		document.body.insertBefore(sliderContainer, document.body.firstChild);
		// --------------------------

		// a table component
		function Table(data) {
			this.data = data;
			this.view = [TableView, this];
		}

		Table.prototype.setCell = function(rowIdx, colIdx, val) {
			// update actual data
			this.data[rowIdx][colIdx] = val;
			// regenerate replacement cell
			var newCell = this.vm.ctx.genCell(rowIdx, colIdx, val);
			// micro-patch it
			this.vm.patch(newCell);
		};

		// view of table component
		function TableView(vm, table) {
			table.vm = vm;

			// exported funcs
			vm.ctx = {
				// cell node generator
				genCell: (rowIdx, colIdx, val) =>
					["td", {_key: rowIdx+"."+colIdx, class: val > 50 ? "high" : "low"}, val]
			};

			return () => ["table", table.data.map((row, rowIdx) =>
				["tr", row.map((val, colIdx) =>
					vm.ctx.genCell(rowIdx, colIdx, val)
				)]
			)];
		}

		function randInt(min, max) {
			return Math.floor(Math.random() * (max - min + 1)) + min;
		}

		// initial data
		var data = [];
		for (var r = 0; r < rows; r++) {
			var row = [];
			for (var c = 0; c < cols; c++)
				row.push(randInt(0,100));
			data.push(row);
		}

		var table = new Table(data);
		var vm = domvm(table.view).mount(document.body);

		function update() {
		  for (var i = 0; i < data.length; i++) {
			var cols = data[i];
			for (var j = 0; j < cols.length; j++) {
			  if (Math.random() < mutations) {
				table.setCell(i, j, randInt(0,100));
			  }
			}
		  }
		};

		function go() {
			profiler.measure('update', update);
			requestAnimationFrame(go);
		}

		profiler.init('update', (document.getElementById('perf')));
/*
		var instr = new DOMInstr(true);

		setTimeout(function() {
			instr.start();
			vm.redraw();
			console.log(instr.end());
		}, 1000);
*/
	</script>
</body>
</html>