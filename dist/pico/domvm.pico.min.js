// https://github.com/leeoniya/domvm (3.x-dev, pico build)

!function(n,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):n.domvm=e()}(this,function(){"use strict";function n(){}function e(n){return null!=n}function t(n){return null!=n&&n.constructor===Object}function r(n,e,t,r){n.splice.apply(n,[t,r].concat(e))}function l(n){return"function"==typeof n}function i(n,e){for(var t in n)if(n[t]!==e[t])return!1;return!0}function o(n,e){var t=n.length;if(e.length!==t)return!1;for(var r=0;r<t;r++)if(n[r]!==e[r])return!1;return!0}function u(n){function e(){t=0,n.apply(r,l)}if(!an)return n;var t,r,l;return function(){r=this,l=arguments,t||(t=an(e))}}function a(n){return"o"===n[0]&&"n"===n[1]}function f(n){return"_"===n[0]}function s(n){return"style"===n}function d(n){n&&n.el&&n.el.offsetHeight}function c(n){return null!=n.node&&null!=n.node.el}function v(n,e){switch(e){case"value":case"checked":case"selected":return!0}return!1}function y(n){for(n=n||fn;null==n.vm&&n.parent;)n=n.parent;return n.vm}function h(){}function p(n){var e=new h;return e.type=nn,e.body=n,e}function g(n,t,r,l){var i=new h;i.type=$,i.flags=l||0,i.attrs=t||null;var o=function(n){return dn.tag=n,dn}(n);if(i.tag=o.tag,o.id||o.class||o.attrs){var u=i.attrs||{};if(o.id&&!e(u.id)&&(u.id=o.id),o.class&&(i._class=o.class,u.class=o.class+(e(u.class)?" "+u.class:"")),o.attrs)for(var a in o.attrs)e(u[a])||(u[a]=o.attrs[a]);i.attrs=u}var f=i.attrs;return e(f)&&(e(f._key)&&(i.key=f._key),e(f._ref)&&(i.ref=f._ref),e(f._hooks)&&(i.hooks=f._hooks),e(f._data)&&(i.data=f._data),e(f._flags)&&(i.flags=f._flags),e(i.key)||(e(i.ref)?i.key=i.ref:e(f.id)?i.key=f.id:e(f.name)&&(i.key=f.name+("radio"===f.type||"checkbox"===f.type?f.value:"")))),null!=r&&(i.body=r),i}function k(n,e,t,l){if(n.type!==rn&&n.type!==tn){n.parent=e,n.idx=t,n.vm=l,null!=n.ref&&function(n,e,t){!function(n,e,t){for(var r;r=e.shift();)0===e.length?n[r]=t:n[r]=n=n[r]||{}}(n,["refs"].concat(e.split(".")),t)}(y(n),n.ref,n);var i=n.hooks,o=l&&l.hooks;(i&&(i.willRemove||i.didRemove)||o&&(o.willUnmount||o.didUnmount))&&function(n){for(;n=n.parent;)n.flags|=cn}(n),sn(n.body)&&function(n){for(var e=n.body,t=0;t<e.length;t++){var l=e[t];!1===l||null==l?e.splice(t--,1):sn(l)?r(e,l,t--,1):(null==l.type&&(e[t]=l=p(""+l)),l.type===nn?null==l.body||""===l.body?e.splice(t--,1):t>0&&e[t-1].type===nn?(e[t-1].body+=l.body,e.splice(t--,1)):k(l,n,t,null):k(l,n,t,null))}}(n)}}function b(n,e){return e}function m(n,e){var t=(n.attrs||fn).style,r=e?(e.attrs||fn).style:null;if(null==t||function(n){var e=typeof n;return"string"===e||"number"===e}(t))n.el.style.cssText=t;else{for(var l in t){var i=t[l];(null==r||null!=i&&i!==r[l])&&(n.el.style[l]=b(0,i))}if(r)for(var o in r)null==t[o]&&(n.el.style[o]="")}}function _(n,e,t,r,l){if(null!=n){var i=t.hooks[e];if(i){if("d"!==e[0]||"i"!==e[1]||"d"!==e[2])return i(t,r);l?d(t.parent)&&i(t,r):pn.push([i,t,r])}}}function w(n){if(pn.length){d(n.node);for(var e;e=pn.shift();)e[0](e[1],e[2])}}function x(n){return n.nextSibling}function N(n){var e=n.vm,t=null!=e&&_(e.hooks,"willUnmount",e,e.data),r=_(n.hooks,"willRemove",n);if((n.flags&cn)===cn&&sn(n.body))for(var l=0;l<n.body.length;l++)N(n.body[l]);return t||r}function A(n,e,t){var r=e._node,l=r.vm;if(sn(r.body))if((r.flags&cn)===cn)for(var i=0;i<r.body.length;i++)A(e,r.body[i].el);else E(r);delete e._node,n.removeChild(e),_(r.hooks,"didRemove",r,null,t),null!=l&&(_(l.hooks,"didUnmount",l,l.data,t),l.node=null)}function C(n,e){var t=e._node;if(!t._dead){var r=N(t);null!=r&&function(n){return"object"==typeof n&&l(n.then)}(r)?(t._dead=!0,r.then(function(n,e,t){return function(){return n.apply(t,e)}}(A,[n,e,!0]))):A(n,e)}}function E(n){for(var e=n.body,t=0;t<e.length;t++){var r=e[t];delete r.el._node,null!=r.vm&&(r.vm.node=null),sn(r.body)&&E(r)}}function S(n){var e=n.el;if(0==(n.flags&cn))sn(n.body)&&E(n),e.textContent=null;else{var t=e.firstChild;do{var r=x(t);C(e,t)}while(t=r)}}function R(n,e,t){var r=e._node,l=null!=e.parentNode,i=e!==t&&l?null:r.vm;null!=i&&_(i.hooks,"willMount",i,i.data),_(r.hooks,l?"willReinsert":"willInsert",r),n.insertBefore(e,t),_(r.hooks,l?"didReinsert":"didInsert",r),null!=i&&_(i.hooks,"didMount",i,i.data)}function V(n,e,t){R(n,e,t?x(t):null)}function T(n,e,t){n[e]=t}function j(n,e,t,r,l){var i=n.apply(l,e.concat([t,r,l,l.data]));l.onevent(t,r,l,l.data,e),gn.call(null,t,r,l,l.data,e),!1===i&&(t.preventDefault(),t.stopPropagation())}function D(n){var e,t,r=function(n){for(;null==n._node;)n=n.parentNode;return n._node}(n.target),l=y(r),i=n.currentTarget._node.attrs["on"+n.type];if(sn(i))j(e=i[0],t=i.slice(1),n,r,l);else for(var o in i)if(n.target.matches(o)){var u=i[o];sn(u)?(e=u[0],t=u.slice(1)):(e=u,t=[]),j(e,t,n,r,l)}}function I(n,e,t,r){if(t!==r){var i=n.el;null==t||l(t)?T(i,e,t):null==r&&T(i,e,D)}}function L(n,e,t){"."===e[0]&&(e=e.substr(1),t=!0),t?n.el[e]="":n.el.removeAttribute(e)}function M(n,e,t,r,l){var i=n.el;null==t?!l&&L(n,e,!1):null!=n.ns?i.setAttribute(e,t):"class"===e?i.className=t:"id"===e||"boolean"==typeof t||r?i[e]=t:"."===e[0]?i[e.substr(1)]=t:i.setAttribute(e,t)}function U(n,e,t){var r=n.attrs||fn,l=e.attrs||fn;if(r===l);else{for(var i in r){var o=r[i],u=v(n.tag,i),d=u?n.el[i]:l[i];o===d||(s(i)?m(n,e):f(i)||(a(i)?I(n,i,o,d):M(n,i,o,u,t)))}for(var i in l)!(i in r)&&!f(i)&&L(n,i,v(n.tag,i)||a(i))}}function O(n,e,t,r){return n.type===tn&&(e=n.data,t=n.key,r=n.opts,n=n.view),new Z(n,e,t,r)}function Y(n){for(var e=0;e<n.body.length;e++){var t=n.body[e],r=t.type;if(r<=en)R(n.el,B(t));else if(r===tn){r=(l=O(t.view,t.data,t.key,t.opts)._redraw(n,e,!1)).node.type,R(n.el,B(l.node))}else if(r===rn){var l;(l=t.vm)._redraw(n,e),r=l.node.type,R(n.el,l.node.el)}}}function B(n,e){return null==n.el&&(n.type===$?(n.el=e||function(n,e){return null!=e?un.createElementNS(e,n):un.createElement(n)}(n.tag,n.ns),null!=n.attrs&&U(n,fn,!0),(n.flags&hn)===hn&&n.body.body(n),sn(n.body)?Y(n):null!=n.body&&""!==n.body&&(n.el.textContent=n.body)):n.type===nn?n.el=e||function(n){return un.createTextNode(n)}(n.body):n.type===en&&(n.el=e||function(n){return un.createComment(n)}(n.body))),n.el._node=n,n.el}function F(n,e,t,r,l,i,o,u){return function(a,f,s,d,c,v){var y,h;if(null!=d[r]){if(null==(y=d[r]._node))return void(d[r]=n(d[r]));if(function(n){return n.parent}(y)!==a)return h=n(d[r]),null!=y.vm?y.vm.unmount(!0):C(f,d[r]),void(d[r]=h)}if(d[l]==c)return bn;if(null==d[l].el)t(f,B(d[l]),d[r]),d[l]=e(d[l],s);else if(d[l].el===d[r])d[l]=e(d[l],s),d[r]=n(d[r]);else{if(v||y!==d[o])return v&&null!=d[r]?function(n,e,t,r,l,i,o,u,a){if(u._lis)t(i,a[l].el,a[r]),a[l]=e(a[l],o);else{var f=function(n,e){var t,r=0,l=e.length-1;if(l<=2147483647)for(;r<=l;){if(t=r+l>>1,e[t]===n)return t;e[t]<n?r=t+1:l=t-1}else for(;r<=l;){if(t=Math.floor((r+l)/2),e[t]===n)return t;e[t]<n?r=t+1:l=t-1}return r==e.length?null:r}(u.idx,a.tombs);u._lis=!0;var s=n(a[r]);t(i,a[r],null!=f?o[a.tombs[f]].el:f),null==f?a.tombs.push(u.idx):a.tombs.splice(f,0,u.idx),a[r]=s}}(n,e,t,r,l,f,s,y,d):kn;h=d[r],d[r]=n(h),u(f,h,d[i]),d[i]=h}}}function P(n,e){var t=e.body,r=n.el,l=n.body,i={lftNode:l[0],rgtNode:l[l.length-1],lftSib:(t[0]||fn).el,rgtSib:(t[t.length-1]||fn).el};n:for(;;){for(;;){var o=mn(n,r,l,i,null,!1);if(o===kn)break;if(o===bn)break n}for(;;){var u=_n(n,r,l,i,i.lftNode,!1);if(u===kn)break;if(u===bn)break n}!function(n,e,t,r){for(var l=Array.prototype.slice.call(e.childNodes),i=[],o=0;o<l.length;o++){var u=l[o]._node;u.parent===n&&i.push(u.idx)}for(var a=function(n){var e=n.slice(),t=[];t.push(0);for(var r,l,i=0,o=n.length;i<o;++i){var u=t[t.length-1];if(n[u]<n[i])e[i]=u,t.push(i);else{for(r=0,l=t.length-1;r<l;){var a=(r+l)/2|0;n[t[a]]<n[i]?r=a+1:l=a}n[i]<n[t[r]]&&(r>0&&(e[i]=t[r-1]),t[r]=i)}}for(l=t[(r=t.length)-1];r-- >0;)t[r]=l,l=e[l];return t}(i).map(function(n){return i[n]}),f=0;f<a.length;f++)t[a[f]]._lis=!0;r.tombs=a;for(;;){var s=mn(n,e,t,r,null,!0);if(s===bn)break}}(n,r,l,i);break}}function q(n){return n.el._node.parent!==n.parent}function z(n,e,t){return e[t]}function H(n,e,t){for(;t<e.length;t++){var r=e[t];if(null!=r.vm){if(n.type===tn&&r.vm.view===n.view&&r.vm.key===n.key||n.type===rn&&r.vm===n.vm)return r}else if(!q(r)&&n.tag===r.tag&&n.type===r.type&&n.key===r.key&&(n.flags&~cn)==(r.flags&~cn))return r}return null}function K(n,e,t){if(null==e._keys){if(e[t].key===n.key)return e[t];for(var r={},l=0;l<e.length;l++)r[e[l].key]=l;e._keys=r}return e[e._keys[n.key]]}function X(e,t){_(t.hooks,"willRecycle",t,e);var r=e.el=t.el,l=t.body,i=e.body;if(r._node=e,e.type!==nn||i===l){null==e.attrs&&null==t.attrs||U(e,t,!1);var o=sn(l),u=sn(i),a=(e.flags&hn)===hn;o?u||a?function(e,t){var r=e.body,l=r.length,i=t.body,o=i.length,u=(e.flags&hn)===hn,a=(e.flags&vn)===vn,f=(e.flags&yn)===yn,s=!a&&e.type===$,d=!0,v=0===o?n:f?K:a||u?z:H;if(s&&0===l)return S(t),void(u&&(e.body=[]));var y,h,p=0,g=!1,b=0;if(u)var m={key:null},_=Array(l);for(var w=0;w<l;w++){if(u){var x=!1,N=null;d&&(f&&(m.key=r.key(w)),y=v(m,i,b)),null!=y?(h=y.idx,!0===(N=r.diff(w,y))?((A=y).parent=e,A.idx=w,A._lis=!1):x=!0):x=!0,x&&(k(A=r.tpl(w),e,w),A._diff=null!=N?N:r.diff(w),null!=y&&X(A,y)),_[w]=A}else{var A=r[w],C=A.type;if(C<=en)(y=d&&v(A,i,b))&&(X(A,y),h=y.idx);else if(C===tn){if(y=d&&v(A,i,b)){h=y.idx;var E=y.vm._update(A.data,e,w)}else var E=O(A.view,A.data,A.key,A.opts)._redraw(e,w,!1);C=E.node.type}else if(C===rn){var R=c(A.vm),E=A.vm._update(A.data,e,w,R);C=E.node.type}}if(null!=y&&(h===b?++b===o&&l>o&&(y=null,d=!1):g=!0,!f&&o>100&&g&&++p%10==0))for(;b<o&&q(i[b]);)b++}u&&(e.body=_);s&&P(e,t)}(e,t):i!==l&&(null!=i?r.textContent=i:S(t)):u?(S(t),Y(e)):i!==l&&(r.firstChild?r.firstChild.nodeValue=i:r.textContent=i),_(t.hooks,"didRecycle",t,e)}else r.nodeValue=i}function Z(n,e,r,i){var o=this;o.view=n,o.data=e,o.key=r,i&&(o.opts=i,o.config(i));var a=t(n)?n:n.call(o,o,e,r,i);l(a)?o.render=a:(o.render=a.render,o.config(a)),o._redrawAsync=u(function(n){return o.redraw(!0)}),o._updateAsync=u(function(n){return o.update(n,!0)}),o.init&&o.init.call(o,o,o.data,o.key,i)}function G(n,e,t,r){return null!=t&&(t.body[r]=e,e.idx=r,e.parent=t,e._lis=!1),n}function J(n,e,r,l){var i,o;return null==r?t(e)?i=e:o=e:(i=e,o=r),g(n,i,o,l)}function Q(n,e,t,r){this.view=n,this.data=e,this.key=t,this.opts=r}function W(n){this.vm=n}var $=1,nn=2,en=3,tn=4,rn=5,ln="undefined"!=typeof window,on=ln?window:{},un=ln?document:{},an=on.requestAnimationFrame,fn={},sn=Array.isArray,dn=(h.prototype={constructor:h,type:null,vm:null,key:null,ref:null,data:null,hooks:null,ns:null,el:null,tag:null,attrs:null,body:null,flags:0,_class:null,_diff:null,_dead:!1,_lis:!1,idx:null,parent:null},{}),cn=1,vn=2,yn=4,hn=8,pn=[],gn=n,kn=1,bn=2,mn=F(x,function(n,e){return e[n.idx+1]},R,"lftSib","lftNode","rgtSib","rgtNode",V),_n=F(function(n){return n.previousSibling},function(n,e){return e[n.idx-1]},V,"rgtSib","rgtNode","lftSib","lftNode",R),wn=(Z.prototype={constructor:Z,_diff:null,init:null,view:null,key:null,data:null,state:null,api:null,opts:null,node:null,hooks:null,onevent:n,refs:null,render:null,mount:function(n,e){return e?(S({el:n,flags:0}),this._redraw(null,null,!1),n.nodeName.toLowerCase()!==this.node.tag?(B(this.node),R(n.parentNode,this.node.el,n),n.parentNode.removeChild(n)):R(n.parentNode,B(this.node,n),n)):(this._redraw(null,null),n&&R(n,this.node.el)),n&&w(this),this},unmount:function(n){var e=this.node;C(e.el.parentNode,e.el),n||w(this)},config:function(n){n.init&&(this.init=n.init),n.diff&&(this.diff=n.diff),n.onevent&&(this.onevent=n.onevent),n.hooks&&(this.hooks=function(n){for(var e=arguments,t=1;t<e.length;t++)for(var r in e[t])n[r]=e[t][r];return n}(this.hooks||{},n.hooks))},parent:function(){return y(this.node.parent)},root:function(){for(var n=this.node;n.parent;)n=n.parent;return n.vm},redraw:function(n){return n?this._redraw(null,null,c(this)):this._redrawAsync(),this},update:function(n,e){return e?this._update(n,null,null,c(this)):this._updateAsync(n),this},_update:function(n,e,t,r){return null!=n&&this.data!==n&&(_(this.hooks,"willUpdate",this,n),this.data=n),this._redraw(e,t,r)},_redraw:function(n,e,t){var r,l,u=null==n,a=this.node&&this.node.el&&this.node.el.parentNode,f=this.node;if(null!=this.diff&&(r=this._diff,this._diff=l=this.diff(this,this.data),null!=f)){var s=sn(r)?o:i;if(r===l||s(r,l))return G(this,f,n,e)}a&&_(this.hooks,"willRedraw",this,this.data);var d=this.render.call(this,this,this.data,r,l);if(d===f)return G(this,f,n,e);if(this.refs=null,null!=this.key&&d.key!==this.key&&(d.key=this.key),this.node=d,n?(k(d,n,e,this),n.body[e]=d):f&&f.parent?(k(d,f.parent,f.idx,this),f.parent.body[f.idx]=d):k(d,null,null,this),!1!==t)if(f)if(f.tag!==d.tag||f.key!==d.key){f.vm=d.vm=null;var c=f.el.parentNode,v=x(f.el);C(c,f.el),R(c,B(d),v),f.el=d.el,d.vm=this}else X(d,f);else B(d);return a&&_(this.hooks,"didRedraw",this,this.data),u&&a&&w(this),this},_redrawAsync:null,_updateAsync:null},"http://www.w3.org/2000/svg");Q.prototype={constructor:Q,type:tn,view:null,data:null,key:null,opts:null},W.prototype={constructor:W,type:rn,vm:null};return{config:function(n){gn=n.onevent||gn},ViewModel:Z,VNode:h,createView:O,defineElement:J,defineSvgElement:function(n,e,t,r){var l=J(n,e,t,r);return l.ns=wn,l},defineText:p,defineComment:function(n){var e=new h;return e.type=en,e.body=n,e},defineView:function(n,e,t,r){return new Q(n,e,t,r)},injectView:function(n){return new W(n)},injectElement:function(n){var e=new h;return e.type=$,e.el=e.key=n,e},lazyList:function(n,e){var t=n.length,r={items:n,length:t,key:function(t){return e.key(n[t],t)},diff:function(t,r){var l=e.diff(n[t],t);if(null==r)return l;var u=r._diff;return(l===u||sn(u)?o(l,u):i(l,u))||l},tpl:function(t){return e.tpl(n[t],t)},map:function(n){return e.tpl=n,r},body:function(n){for(var e=Array(t),l=0;l<t;l++){var i=r.tpl(l);i._diff=r.diff(l),e[l]=i,k(i,n,l)}n.body=e}};return r},FIXED_BODY:vn,DEEP_REMOVE:cn,KEYED_LIST:yn,LAZY_LIST:hn}});