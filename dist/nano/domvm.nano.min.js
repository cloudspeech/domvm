// https://github.com/leeoniya/domvm (3.x-dev, nano build)

!function(n,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):n.domvm=t()}(this,function(){"use strict";function n(){}function t(n){return null!=n}function e(n){return null!=n&&n.constructor===Object}function r(n,t,e,r){n.splice.apply(n,[e,r].concat(t))}function l(n){return"function"==typeof n}function i(n){for(var t=arguments,e=1;e<t.length;e++)for(var r in t[e])n[r]=t[e][r];return n}function o(n,t){for(var e in n)if(n[e]!==t[e])return!1;return!0}function u(n,t){var e=n.length;if(t.length!==e)return!1;for(var r=0;r<e;r++)if(n[r]!==t[r])return!1;return!0}function a(n){function t(){e=0,n.apply(r,l)}if(!fn)return n;var e,r,l;return function(){r=this,l=arguments,e||(e=fn(t))}}function f(n){return"o"===n[0]&&"n"===n[1]}function s(n){return"_"===n[0]}function d(n){return"style"===n}function c(n){n&&n.el&&n.el.offsetHeight}function v(n){return null!=n.node&&null!=n.node.el}function h(n,t){switch(t){case"value":case"checked":case"selected":return!0}return!1}function y(n){for(n=n||sn;null==n.vm&&n.parent;)n=n.parent;return n.vm}function p(){}function g(n){var t=new p;return t.type=tn,t.body=n,t}function m(n,e,r,l){var i=new p;i.type=nn,t(l)&&(i.flags=l),i.attrs=e;var o=function(n){var t=vn[n];if(null==t){var e,r,l,i;for(vn[n]=t={tag:(e=n.match(/^[-\w]+/))?e[0]:"div",id:(r=n.match(/#([-\w]+)/))?r[1]:null,class:(l=n.match(/\.([-\w.]+)/))?l[1].replace(/\./g," "):null,attrs:null};i=hn.exec(n);)null==t.attrs&&(t.attrs={}),t.attrs[i[1]]=i[2]||""}return t}(n);if(i.tag=o.tag,o.id||o.class||o.attrs){var u=i.attrs||{};if(o.id&&!t(u.id)&&(u.id=o.id),o.class&&(i._class=o.class,u.class=o.class+(t(u.class)?" "+u.class:"")),o.attrs)for(var a in o.attrs)t(u[a])||(u[a]=o.attrs[a]);i.attrs=u}var f=i.attrs;return t(f)&&(t(f._key)&&(i.key=f._key),t(f._ref)&&(i.ref=f._ref),t(f._hooks)&&(i.hooks=f._hooks),t(f._data)&&(i.data=f._data),t(f._flags)&&(i.flags=f._flags),t(i.key)||(t(i.ref)?i.key=i.ref:t(f.id)?i.key=f.id:t(f.name)&&(i.key=f.name+("radio"===f.type||"checkbox"===f.type?f.value:"")))),null!=r&&(i.body=r),i}function b(n,t,e,l){if(n.type!==ln&&n.type!==rn){n.parent=t,n.idx=e,n.vm=l,null!=n.ref&&function(n,t,e){!function(n,t,e){for(var r;r=t.shift();)0===t.length?n[r]=e:n[r]=n=n[r]||{}}(n,["refs"].concat(t.split(".")),e)}(y(n),n.ref,n);var i=n.hooks,o=l&&l.hooks;(i&&(i.willRemove||i.didRemove)||o&&(o.willUnmount||o.didUnmount))&&function(n){for(;n=n.parent;)n.flags|=yn}(n),dn(n.body)&&function(n){for(var t=n.body,e=0;e<t.length;e++){var l=t[e];!1===l||null==l?t.splice(e--,1):dn(l)?r(t,l,e--,1):(null==l.type&&(t[e]=l=g(""+l)),l.type===tn?null==l.body||""===l.body?t.splice(e--,1):e>0&&t[e-1].type===tn?(t[e-1].body+=l.body,t.splice(e--,1)):b(l,n,e,null):b(l,n,e,null))}}(n)}}function k(n,t){return t}function _(n,t){var e=(n.attrs||sn).style,r=t?(t.attrs||sn).style:null;if(null==e||function(n){var t=typeof n;return"string"===t||"number"===t}(e))n.el.style.cssText=e;else{for(var l in e){var i=e[l];(null==r||null!=i&&i!==r[l])&&(n.el.style[l]=k(0,i))}if(r)for(var o in r)null==e[o]&&(n.el.style[o]="")}}function w(n,t,e,r,l){if(null!=n){var i=e.hooks[t];if(i){if("d"!==t[0]||"i"!==t[1]||"d"!==t[2])return i(e,r);l?c(e.parent)&&i(e,r):bn.push([i,e,r])}}}function x(n){if(bn.length){c(n.node);for(var t;t=bn.shift();)t[0](t[1],t[2])}}function N(n){return n.nextSibling}function A(n){var t=n.vm,e=null!=t&&w(t.hooks,"willUnmount",t,t.data),r=w(n.hooks,"willRemove",n);if((n.flags&yn)===yn&&dn(n.body))for(var l=0;l<n.body.length;l++)A(n.body[l]);return e||r}function C(n,t,e){var r=t._node,l=r.vm;if(dn(r.body))if((r.flags&yn)===yn)for(var i=0;i<r.body.length;i++)C(t,r.body[i].el);else S(r);delete t._node,n.removeChild(t),w(r.hooks,"didRemove",r,null,e),null!=l&&(w(l.hooks,"didUnmount",l,l.data,e),l.node=null)}function E(n,t){var e=t._node;if(!e._dead){var r=A(e);null!=r&&function(n){return"object"==typeof n&&l(n.then)}(r)?(e._dead=!0,r.then(function(n,t,e){return function(){return n.apply(e,t)}}(C,[n,t,!0]))):C(n,t)}}function S(n){for(var t=n.body,e=0;e<t.length;e++){var r=t[e];delete r.el._node,null!=r.vm&&(r.vm.node=null),dn(r.body)&&S(r)}}function R(n){var t=n.el;if(0==(n.flags&yn))dn(n.body)&&S(n),t.textContent=null;else{var e=t.firstChild;do{var r=N(e);E(t,e)}while(e=r)}}function V(n,t,e){var r=t._node,l=null!=t.parentNode,i=t!==e&&l?null:r.vm;null!=i&&w(i.hooks,"willMount",i,i.data),w(r.hooks,l?"willReinsert":"willInsert",r),n.insertBefore(t,e),w(r.hooks,l?"didReinsert":"didInsert",r),null!=i&&w(i.hooks,"didMount",i,i.data)}function j(n,t,e){V(n,t,e?N(e):null)}function T(n,t,e){n[t]=e}function D(n,t,e,r,l){var i=n.apply(l,t.concat([e,r,l,l.data]));l.onevent(e,r,l,l.data,t),kn.call(null,e,r,l,l.data,t),!1===i&&(e.preventDefault(),e.stopPropagation())}function I(n){var t,e,r=function(n){for(;null==n._node;)n=n.parentNode;return n._node}(n.target),l=y(r),i=n.currentTarget._node.attrs["on"+n.type];if(dn(i))D(t=i[0],e=i.slice(1),n,r,l);else for(var o in i)if(n.target.matches(o)){var u=i[o];dn(u)?(t=u[0],e=u.slice(1)):(t=u,e=[]),D(t,e,n,r,l)}}function L(n,t,e,r){if(e!==r){var i=n.el;null==e||l(e)?T(i,t,e):null==r&&T(i,t,I)}}function M(n,t,e){"."===t[0]&&(t=t.substr(1),e=!0),e?n.el[t]="":n.el.removeAttribute(t)}function U(n,t,e,r,l){var i=n.el;null==e?!l&&M(n,t,!1):null!=n.ns?i.setAttribute(t,e):"class"===t?i.className=e:"id"===t||"boolean"==typeof e||r?i[t]=e:"."===t[0]?i[t.substr(1)]=e:i.setAttribute(t,e)}function O(n,t,e){var r=n.attrs||sn,l=t.attrs||sn;if(r===l);else{for(var i in r){var o=r[i],u=h(n.tag,i),a=u?n.el[i]:l[i];o===a||(d(i)?_(n,t):s(i)||(f(i)?L(n,i,o,a):U(n,i,o,u,e)))}for(var i in l)!(i in r)&&!s(i)&&M(n,i,h(n.tag,i)||f(i))}}function Y(n,t,e,r){return n.type===rn&&(t=n.data,e=n.key,r=n.opts,n=n.view),new G(n,t,e,r)}function B(n){for(var t=0;t<n.body.length;t++){var e=n.body[t],r=e.type;if(r<=en)V(n.el,F(e));else if(r===rn){r=(l=Y(e.view,e.data,e.key,e.opts)._redraw(n,t,!1)).node.type,V(n.el,F(l.node))}else if(r===ln){var l;(l=e.vm)._redraw(n,t),r=l.node.type,V(n.el,l.node.el)}}}function F(n,t){return null==n.el&&(n.type===nn?(n.el=t||function(n,t){return null!=t?an.createElementNS(t,n):an.createElement(n)}(n.tag,n.ns),null!=n.attrs&&O(n,sn,!0),(n.flags&mn)===mn&&n.body.body(n),dn(n.body)?B(n):null!=n.body&&""!==n.body&&(n.el.textContent=n.body)):n.type===tn?n.el=t||function(n){return an.createTextNode(n)}(n.body):n.type===en&&(n.el=t||function(n){return an.createComment(n)}(n.body))),n.el._node=n,n.el}function P(n,t,e,r,l,i,o,u){return function(a,f,s,d,c,v){var h,y;if(null!=d[r]){if(null==(h=d[r]._node))return void(d[r]=n(d[r]));if(function(n){return n.parent}(h)!==a)return y=n(d[r]),null!=h.vm?h.vm.unmount(!0):E(f,d[r]),void(d[r]=y)}if(d[l]==c)return wn;if(null==d[l].el)e(f,F(d[l]),d[r]),d[l]=t(d[l],s);else if(d[l].el===d[r])d[l]=t(d[l],s),d[r]=n(d[r]);else{if(v||h!==d[o])return v&&null!=d[r]?function(n,t,e,r,l,i,o,u,a){if(u._lis)e(i,a[l].el,a[r]),a[l]=t(a[l],o);else{var f=function(n,t){var e,r=0,l=t.length-1;if(l<=2147483647)for(;r<=l;){if(e=r+l>>1,t[e]===n)return e;t[e]<n?r=e+1:l=e-1}else for(;r<=l;){if(e=Math.floor((r+l)/2),t[e]===n)return e;t[e]<n?r=e+1:l=e-1}return r==t.length?null:r}(u.idx,a.tombs);u._lis=!0;var s=n(a[r]);e(i,a[r],null!=f?o[a.tombs[f]].el:f),null==f?a.tombs.push(u.idx):a.tombs.splice(f,0,u.idx),a[r]=s}}(n,t,e,r,l,f,s,h,d):_n;y=d[r],d[r]=n(y),u(f,y,d[i]),d[i]=y}}}function q(n,t){var e=t.body,r=n.el,l=n.body,i={lftNode:l[0],rgtNode:l[l.length-1],lftSib:(e[0]||sn).el,rgtSib:(e[e.length-1]||sn).el};n:for(;;){for(;;){var o=xn(n,r,l,i,null,!1);if(o===_n)break;if(o===wn)break n}for(;;){var u=Nn(n,r,l,i,i.lftNode,!1);if(u===_n)break;if(u===wn)break n}!function(n,t,e,r){for(var l=Array.prototype.slice.call(t.childNodes),i=[],o=0;o<l.length;o++){var u=l[o]._node;u.parent===n&&i.push(u.idx)}for(var a=function(n){var t=n.slice(),e=[];e.push(0);for(var r,l,i=0,o=n.length;i<o;++i){var u=e[e.length-1];if(n[u]<n[i])t[i]=u,e.push(i);else{for(r=0,l=e.length-1;r<l;){var a=(r+l)/2|0;n[e[a]]<n[i]?r=a+1:l=a}n[i]<n[e[r]]&&(r>0&&(t[i]=e[r-1]),e[r]=i)}}for(l=e[(r=e.length)-1];r-- >0;)e[r]=l,l=t[l];return e}(i).map(function(n){return i[n]}),f=0;f<a.length;f++)e[a[f]]._lis=!0;r.tombs=a;for(;;){var s=xn(n,t,e,r,null,!0);if(s===wn)break}}(n,r,l,i);break}}function z(n){return n.el._node.parent!==n.parent}function H(n,t,e){return t[e]}function K(n,t,e){for(;e<t.length;e++){var r=t[e];if(null!=r.vm){if(n.type===rn&&r.vm.view===n.view&&r.vm.key===n.key||n.type===ln&&r.vm===n.vm)return r}else if(!z(r)&&n.tag===r.tag&&n.type===r.type&&n.key===r.key&&(n.flags&~yn)==(r.flags&~yn))return r}return null}function X(n,t,e){return t[t._keys[n.key]]}function Z(n,t){w(t.hooks,"willRecycle",t,n);var e=n.el=t.el,r=t.body,l=n.body;if(e._node=n,n.type!==tn||l===r){null==n.attrs&&null==t.attrs||O(n,t,!1);var i=dn(r),o=dn(l),u=(n.flags&mn)===mn;i?o||u?function(n,t){var e=n.body,r=e.length,l=t.body,i=l.length,o=(n.flags&mn)===mn,u=(n.flags&pn)===pn,a=(n.flags&gn)===gn,f=!u&&n.type===nn,s=!0,d=a?X:u||o?H:K;if(a){for(var c={},h=0;h<l.length;h++)c[l[h].key]=h;l._keys=c}if(f&&0===r)return R(t),void(o&&(n.body=[]));var y,p,g=0,m=!1,k=0;if(o)var _={key:null},w=Array(r);for(var h=0;h<r;h++){if(o){var x=!1,N=null;s&&(a&&(_.key=e.key(h)),y=d(_,l,k)),null!=y?(p=y.idx,!0===(N=e.diff(h,y))?((A=y).parent=n,A.idx=h,A._lis=!1):x=!0):x=!0,x&&(b(A=e.tpl(h),n,h),A._diff=null!=N?N:e.diff(h),null!=y&&Z(A,y)),w[h]=A}else{var A=e[h],C=A.type;if(C<=en)(y=s&&d(A,l,k))&&(Z(A,y),p=y.idx);else if(C===rn){if(y=s&&d(A,l,k)){p=y.idx;var E=y.vm._update(A.data,n,h)}else var E=Y(A.view,A.data,A.key,A.opts)._redraw(n,h,!1);C=E.node.type}else if(C===ln){var S=v(A.vm),E=A.vm._update(A.data,n,h,S);C=E.node.type}}if(!a&&null!=y&&(p===k?++k===i&&r>i&&(y=null,s=!1):m=!0,i>100&&m&&++g%10==0))for(;k<i&&z(l[k]);)k++}o&&(n.body=w);f&&q(n,t)}(n,t):l!==r&&(null!=l?e.textContent=l:R(t)):o?(R(t),B(n)):l!==r&&(e.firstChild?e.firstChild.nodeValue=l:e.textContent=l),w(t.hooks,"didRecycle",t,n)}else e.nodeValue=l}function G(n,t,r,i){var o=this;o.view=n,o.data=t,o.key=r,i&&(o.opts=i,o.config(i));var u=e(n)?n:n.call(o,o,t,r,i);l(u)?o.render=u:(o.render=u.render,o.config(u)),o._redrawAsync=a(function(n){return o.redraw(!0)}),o._updateAsync=a(function(n){return o.update(n,!0)}),o.init&&o.init.call(o,o,o.data,o.key,i)}function J(n,t,e,r){return null!=e&&(e.body[r]=t,t.idx=r,t.parent=e,t._lis=!1),n}function Q(n,t,r,l){var i,o;return null==r?e(t)?i=t:o=t:(i=t,o=r),m(n,i,o,l)}function W(n,t,e,r){this.view=n,this.data=t,this.key=e,this.opts=r}function $(n){this.vm=n}var nn=1,tn=2,en=3,rn=4,ln=5,on="undefined"!=typeof window,un=on?window:{},an=on?document:{},fn=un.requestAnimationFrame,sn={},dn=Array.isArray,cn=p.prototype={constructor:p,type:null,vm:null,key:null,ref:null,data:null,hooks:null,ns:null,el:null,tag:null,attrs:null,body:null,flags:0,_class:null,_diff:null,_dead:!1,_lis:!1,idx:null,parent:null},vn={},hn=/\[(\w+)(?:=(\w+))?\]/g,yn=1,pn=2,gn=4,mn=8,bn=[],kn=n,_n=1,wn=2,xn=P(N,function(n,t){return t[n.idx+1]},V,"lftSib","lftNode","rgtSib","rgtNode",j),Nn=P(function(n){return n.previousSibling},function(n,t){return t[n.idx-1]},j,"rgtSib","rgtNode","lftSib","lftNode",V),An=(G.prototype={constructor:G,_diff:null,init:null,view:null,key:null,data:null,state:null,api:null,opts:null,node:null,hooks:null,onevent:n,refs:null,render:null,mount:function(n,t){return t?(R({el:n,flags:0}),this._redraw(null,null,!1),n.nodeName.toLowerCase()!==this.node.tag?(F(this.node),V(n.parentNode,this.node.el,n),n.parentNode.removeChild(n)):V(n.parentNode,F(this.node,n),n)):(this._redraw(null,null),n&&V(n,this.node.el)),n&&x(this),this},unmount:function(n){var t=this.node;E(t.el.parentNode,t.el),n||x(this)},config:function(n){n.init&&(this.init=n.init),n.diff&&(this.diff=n.diff),n.onevent&&(this.onevent=n.onevent),n.hooks&&(this.hooks=i(this.hooks||{},n.hooks))},parent:function(){return y(this.node.parent)},root:function(){for(var n=this.node;n.parent;)n=n.parent;return n.vm},redraw:function(n){return n?this._redraw(null,null,v(this)):this._redrawAsync(),this},update:function(n,t){return t?this._update(n,null,null,v(this)):this._updateAsync(n),this},_update:function(n,t,e,r){return null!=n&&this.data!==n&&(w(this.hooks,"willUpdate",this,n),this.data=n),this._redraw(t,e,r)},_redraw:function(n,t,e){var r,l,i=null==n,a=this.node&&this.node.el&&this.node.el.parentNode,f=this.node;if(null!=this.diff&&(r=this._diff,this._diff=l=this.diff(this,this.data),null!=f)){var s=dn(r)?u:o;if(r===l||s(r,l))return J(this,f,n,t)}a&&w(this.hooks,"willRedraw",this,this.data);var d=this.render.call(this,this,this.data,r,l);if(d===f)return J(this,f,n,t);if(this.refs=null,null!=this.key&&d.key!==this.key&&(d.key=this.key),this.node=d,n?(b(d,n,t,this),n.body[t]=d):f&&f.parent?(b(d,f.parent,f.idx,this),f.parent.body[f.idx]=d):b(d,null,null,this),!1!==e)if(f)if(f.tag!==d.tag||f.key!==d.key){f.vm=d.vm=null;var c=f.el.parentNode,v=N(f.el);E(c,f.el),V(c,F(d),v),f.el=d.el,d.vm=this}else Z(d,f);else F(d);return a&&w(this.hooks,"didRedraw",this,this.data),i&&a&&x(this),this},_redrawAsync:null,_updateAsync:null},"http://www.w3.org/2000/svg");W.prototype={constructor:W,type:rn,view:null,data:null,key:null,opts:null},$.prototype={constructor:$,type:ln,vm:null};var Cn={config:function(n){kn=n.onevent||kn},ViewModel:G,VNode:p,createView:Y,defineElement:Q,defineSvgElement:function(n,t,e,r){var l=Q(n,t,e,r);return l.ns=An,l},defineText:g,defineComment:function(n){var t=new p;return t.type=en,t.body=n,t},defineView:function(n,t,e,r){return new W(n,t,e,r)},injectView:function(n){return new $(n)},injectElement:function(n){var t=new p;return t.type=nn,t.el=t.key=n,t},lazyList:function(n,t){var e=n.length,r={items:n,length:e,key:function(e){return t.key(n[e],e)},diff:function(e,r){var l=t.diff(n[e],e);if(null==r)return l;var i=r._diff;return(l===i||dn(i)?u(l,i):o(l,i))||l},tpl:function(e){return t.tpl(n[e],e)},map:function(n){return t.tpl=n,r},body:function(n){for(var t=Array(e),l=0;l<e;l++){var i=r.tpl(l);i._diff=r.diff(l),t[l]=i,b(i,n,l)}n.body=t}};return r},FIXED_BODY:pn,DEEP_REMOVE:yn,KEYED_LIST:gn,LAZY_LIST:mn};return cn.patch=function(n,t){!function(n,t,e){if(null!=t.type){if(null!=n.vm)return;b(t,n.parent,n.idx,null),n.parent.body[n.idx]=t,Z(t,n),e&&c(t),x(y(t))}else{var r=Object.create(n);r.attrs=i({},n.attrs);var l=i(n.attrs,t);if(null!=n._class){var o=l.class;l.class=null!=o&&""!==o?n._class+" "+o:n._class}O(n,r),e&&c(n)}}(this,n,t)},Cn});