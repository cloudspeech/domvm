// https://github.com/leeoniya/domvm (3.x-dev, nano build)
!function(n,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):n.domvm=e()}(this,function(){"use strict";var n=1,e=2,t=3,l=4,r=5,i="undefined"!=typeof window,o=i?window:{},u=i?document:{},a=o.requestAnimationFrame,f={};function s(){}var d=Array.isArray;function c(n){return null!=n&&n.constructor===Object}function v(n){return"function"==typeof n}function y(n){for(var e=arguments,t=1;t<e.length;t++)for(var l in e[t])n[l]=e[t][l];return n}function h(n,e){for(var t in n)if(n[t]!==e[t])return!1;return!0}function p(n,e){var t=n.length;if(e.length!==t)return!1;for(var l=0;l<t;l++)if(n[l]!==e[l])return!1;return!0}function g(n){if(!a)return n;var e,t,l;function r(){e=0,n.apply(t,l)}return function(){t=this,l=arguments,e||(e=a(r))}}function b(n){return"o"===n[0]&&"n"===n[1]}function m(n){return"_"===n[0]}function k(n){n&&n.el&&n.el.offsetHeight}function _(n){return null!=n.node&&null!=n.node.el}function w(n,e){switch(e){case"value":case"checked":case"selected":return!0}return!1}function x(n){for(n=n||f;null==n.vm&&n.parent;)n=n.parent;return n.vm}function N(){}var A=N.prototype={constructor:N,type:null,vm:null,key:null,ref:null,data:null,hooks:null,ns:null,el:null,tag:null,attrs:null,body:null,flags:0,_class:null,_diff:null,_dead:!1,_lis:!1,idx:null,parent:null};function R(n){var t=new N;return t.type=e,t.body=n,t}var E={},S=/\[(\w+)(?:=(\w+))?\]/g;var C=1,V=2,j=4,T=8;function D(e,t,l,r){var i=new N;i.type=n,i.flags=r||0,i.attrs=t||null;var o=function(n){var e=E[n];if(null==e){var t,l,r,i;for(E[n]=e={tag:(t=n.match(/^[-\w]+/))?t[0]:"div",id:(l=n.match(/#([-\w]+)/))?l[1]:null,class:(r=n.match(/\.([-\w.]+)/))?r[1].replace(/\./g," "):null,attrs:null};i=S.exec(n);)null==e.attrs&&(e.attrs={}),e.attrs[i[1]]=i[2]||""}return e}(e);i.tag=o.tag;var u=null!=o.id,a=null!=o.class,f=null!=o.attrs;if(u||a||f){var s=i.attrs||{};if(u&&null==s.id&&(s.id=o.id),a&&(i._class=o.class,s.class=o.class+(null!=s.class?" "+s.class:"")),f)for(var d in o.attrs)null==s[d]&&(s[d]=o.attrs[d]);i.attrs=s}var c=i.attrs;return null!=c&&(null!=c._key&&(i.key=c._key),null!=c._ref&&(i.ref=c._ref),null!=c._hooks&&(i.hooks=c._hooks),null!=c._data&&(i.data=c._data),null!=c._flags&&(i.flags=c._flags),null==i.key&&(null!=i.ref?i.key=i.ref:null!=c.id?i.key=c.id:null!=c.name&&(i.key=c.name+("radio"===c.type||"checkbox"===c.type?c.value:"")))),null!=l&&(i.body=l),i}function I(n,t,i,o){if(n.type!==r&&n.type!==l){n.parent=t,n.idx=i,n.vm=o,null!=n.ref&&(u=x(n),a=n.ref,f=n,function(n,e,t){for(var l;l=e.shift();)0===e.length?n[l]=t:n[l]=n=n[l]||{}}(u,["refs"].concat(a.split(".")),f));var u,a,f,s=n.hooks,c=o&&o.hooks;(s&&(s.willRemove||s.didRemove)||c&&(c.willUnmount||c.didUnmount))&&function(n){for(;n=n.parent;)n.flags|=C}(n),d(n.body)?function(n){for(var t=n.body,l=0;l<t.length;l++){var r=t[l];!1===r||null==r?t.splice(l--,1):d(r)?(o=r,u=l--,a=1,(i=t).splice.apply(i,[u,a].concat(o))):(null==r.type&&(t[l]=r=R(""+r)),r.type===e?null==r.body||""===r.body?t.splice(l--,1):l>0&&t[l-1].type===e?(t[l-1].body+=r.body,t.splice(l--,1)):I(r,n,l,null):I(r,n,l,null))}var i,o,u,a}(n):""===n.body&&(n.body=null)}}function L(n,e){var t=(n.attrs||f).style,l=e?(e.attrs||f).style:null;if(null==t||function(n){var e=typeof n;return"string"===e||"number"===e}(t))n.el.style.cssText=t;else{for(var r in t){var i=t[r];(null==l||null!=i&&i!==l[r])&&(n.el.style[r]=(u=i,u))}if(l)for(var o in l)null==t[o]&&(n.el.style[o]="")}var u}var M=[];function U(n,e,t,l,r){if(null!=n){var i=t.hooks[e];if(i){if("d"!==e[0]||"i"!==e[1]||"d"!==e[2])return i(t,l);r?k(t.parent)&&i(t,l):M.push([i,t,l])}}}function O(n){if(M.length){k(n.node);for(var e;e=M.shift();)e[0](e[1],e[2])}}function Y(n){return n.nextSibling}function B(n,e,t){var l=e._node,r=l.vm;if(d(l.body))if((l.flags&C)===C)for(var i=0;i<l.body.length;i++)B(e,l.body[i].el);else P(l);delete e._node,n.removeChild(e),U(l.hooks,"didRemove",l,null,t),null!=r&&(U(r.hooks,"didUnmount",r,r.data,t),r.node=null)}function F(n,e){var t=e._node;if(!t._dead){var l=function n(e){var t=e.vm,l=null!=t&&U(t.hooks,"willUnmount",t,t.data),r=U(e.hooks,"willRemove",e);if((e.flags&C)===C&&d(e.body))for(var i=0;i<e.body.length;i++)n(e.body[i]);return l||r}(t);null!=l&&(u=l,"object"==typeof u&&v(u.then))?(t._dead=!0,l.then((r=B,i=[n,e,!0],o=void 0,function(){return r.apply(o,i)}))):B(n,e);var r,i,o,u}}function P(n){for(var e=n.body,t=0;t<e.length;t++){var l=e[t];delete l.el._node,null!=l.vm&&(l.vm.node=null),d(l.body)&&P(l)}}function q(n){var e=n.el;if(0==(n.flags&C))d(n.body)&&P(n),e.textContent=null;else{var t=e.firstChild;do{var l=Y(t);F(e,t)}while(t=l)}}function z(n,e,t){var l=e._node,r=null!=e.parentNode,i=e!==t&&r?null:l.vm;null!=i&&U(i.hooks,"willMount",i,i.data),U(l.hooks,r?"willReinsert":"willInsert",l),n.insertBefore(e,t),U(l.hooks,r?"didReinsert":"didInsert",l),null!=i&&U(i.hooks,"didMount",i,i.data)}function H(n,e,t){z(n,e,t?Y(t):null)}var K=s,X=!1;function Z(n,e,t){n[e]=t}function G(n,e,t,l,r){var i=n.apply(r,e.concat([t,l,r,r.data]));r.onevent(t,l,r,r.data,e),K.call(null,t,l,r,r.data,e),!1===i&&(t.preventDefault(),t.stopPropagation())}function J(n){var e,t,l=function(n){for(;null==n._node;)n=n.parentNode;return n._node}(n.target),r=x(l),i=n.currentTarget._node.attrs["on"+n.type];if(d(i))G(e=i[0],t=i.slice(1),n,l,r);else for(var o in i)if(n.target.matches(o)){var u=i[o];d(u)?(e=u[0],t=u.slice(1)):(e=u,t=[]),G(e,t,n,l,r)}}function Q(n,e,t,l){if(t!==l){var r=n.el;null==t||v(t)?Z(r,e,t):null==l&&Z(r,e,J)}}function W(n,e,t,l,r){var i=n.el;null!=n.ns?i.setAttribute(e,t):"class"===e?i.className=t:"id"===e||"boolean"==typeof t||l?i[e]=t:"."===e[0]?i[e.substr(1)]=t:i.setAttribute(e,t)}function $(n,e,t){var l=n.attrs||f,r=e.attrs||f;if(l===r);else{for(var i in l){var o=l[i];if(null!=o){var u=w(n.tag,i),a=u?n.el[i]:r[i];o===a||(v=i,"style"===v?L(n,e):m(i)||(b(i)?Q(n,i,o,a):W(n,i,o,u)))}}for(var i in r)null==l[i]&&!m(i)&&(s=n,d=i,c=w(n.tag,i)||b(i),"."===d[0]&&(d=d.substr(1),c=!0),c?s.el[d]="":s.el.removeAttribute(d))}var s,d,c,v}function nn(n,e,t,r){return n.type===l&&(e=n.data,t=n.key,r=n.opts,n=n.view),new hn(n,e,t,r)}function en(n){for(var e=0;e<n.body.length;e++){var i=n.body[e],o=i.type;if(o<=t)z(n.el,tn(i));else if(o===l){o=(u=nn(i.view,i.data,i.key,i.opts)._redraw(n,e,!1)).node.type,z(n.el,tn(u.node))}else if(o===r){var u;(u=i.vm)._redraw(n,e),o=u.node.type,z(n.el,u.node.el)}}}function tn(l,r){null==l.el&&(l.type===n?(l.el=r||(a=l.tag,s=l.ns,null!=s?u.createElementNS(s,a):u.createElement(a)),null!=l.attrs&&$(l,f),(l.flags&T)===T&&l.body.body(l),d(l.body)?en(l):null!=l.body&&(l.el.textContent=l.body)):l.type===e?l.el=r||(o=l.body,u.createTextNode(o)):l.type===t&&(l.el=r||(i=l.body,u.createComment(i))));var i,o,a,s;return l.el._node=l,l.el}var ln=1,rn=2;function on(n,e,t,l,r,i,o,u){return function(a,f,s,d,c,v){var y,h;if(null!=d[l]){if(null==(y=d[l]._node))return void(d[l]=n(d[l]));if(y.parent!==a)return h=n(d[l]),null!=y.vm?y.vm.unmount(!0):F(f,d[l]),void(d[l]=h)}if(d[r]==c)return rn;if(null==d[r].el)t(f,tn(d[r]),d[l]),d[r]=e(d[r],s);else if(d[r].el===d[l])d[r]=e(d[r],s),d[l]=n(d[l]);else{if(v||y!==d[o])return v&&null!=d[l]?function(n,e,t,l,r,i,o,u,a){if(u._lis)t(i,a[r].el,a[l]),a[r]=e(a[r],o);else{var f=function(n,e){var t,l=0,r=e.length-1;if(r<=2147483647)for(;l<=r;){if(e[t=l+r>>1]===n)return t;e[t]<n?l=t+1:r=t-1}else for(;l<=r;){if(e[t=Math.floor((l+r)/2)]===n)return t;e[t]<n?l=t+1:r=t-1}return l==e.length?null:l}(u.idx,a.tombs);u._lis=!0;var s=n(a[l]);t(i,a[l],null!=f?o[a.tombs[f]].el:f),null==f?a.tombs.push(u.idx):a.tombs.splice(f,0,u.idx),a[l]=s}}(n,e,t,l,r,f,s,y,d):ln;h=d[l],d[l]=n(h),u(f,h,d[i]),d[i]=h}}}var un=on(Y,function(n,e){return e[n.idx+1]},z,"lftSib","lftNode","rgtSib","rgtNode",H),an=on(function(n){return n.previousSibling},function(n,e){return e[n.idx-1]},H,"rgtSib","rgtNode","lftSib","lftNode",z);function fn(n,e,t,l){for(var r=Array.prototype.slice.call(e.childNodes),i=[],o=0;o<r.length;o++){var u=r[o]._node;u.parent===n&&i.push(u.idx)}for(var a=function(n){var e=n.slice(),t=[];t.push(0);for(var l,r,i=0,o=n.length;i<o;++i){var u=t[t.length-1];if(n[u]<n[i])e[i]=u,t.push(i);else{for(l=0,r=t.length-1;l<r;){var a=(l+r)/2|0;n[t[a]]<n[i]?l=a+1:r=a}n[i]<n[t[l]]&&(l>0&&(e[i]=t[l-1]),t[l]=i)}}for(r=t[(l=t.length)-1];l-- >0;)t[l]=r,r=e[r];return t}(i).map(function(n){return i[n]}),f=0;f<a.length;f++)t[a[f]]._lis=!0;for(l.tombs=a;;){if(un(n,e,t,l,null,!0)===rn)break}}function sn(n){return n.el._node.parent!==n.parent}function dn(n,e,t){return e[t]}function cn(n,e,t){for(;t<e.length;t++){var i=e[t];if(null!=i.vm){if(n.type===l&&i.vm.view===n.view&&i.vm.key===n.key||n.type===r&&i.vm===n.vm)return i}else if(!sn(i)&&n.tag===i.tag&&n.type===i.type&&n.key===i.key&&(n.flags&~C)==(i.flags&~C))return i}return null}function vn(n,e,t){if(null==e._keys){if(e[t].key===n.key)return e[t];for(var l={},r=0;r<e.length;r++)l[e[r].key]=r;e._keys=l}return e[e._keys[n.key]]}function yn(i,o){U(o.hooks,"willRecycle",o,i);var u=i.el=o.el,a=o.body,c=i.body;if(u._node=i,i.type!==e||c===a){null==i.attrs&&null==o.attrs||$(i,o);var v=d(a),y=d(c),h=(i.flags&T)===T;v?y||h?function(e,i){var o=e.body,u=o.length,a=i.body,d=a.length,c=(e.flags&T)===T,v=(e.flags&V)===V,y=(e.flags&j)===j,h=!v&&e.type===n,p=!0,g=0===d?s:y?vn:v||c?dn:cn;if(h&&0===u)return q(i),void(c&&(e.body=[]));var b,m,k=0,w=!1,x=0;if(c)var N={key:null},A=Array(u);for(var R=0;R<u;R++){if(c){var E=!1,S=null;p&&(y&&(N.key=o.key(R)),b=g(N,a,x)),null!=b?(m=b.idx,!0===(S=o.diff(R,b))?((C=b).parent=e,C.idx=R,C._lis=!1):E=!0):E=!0,E&&(I(C=o.tpl(R),e,R),C._diff=null!=S?S:o.diff(R),null!=b&&yn(C,b)),A[R]=C}else{var C=o[R],D=C.type;if(D<=t)(b=p&&g(C,a,x))&&(yn(C,b),m=b.idx);else if(D===l){if(b=p&&g(C,a,x)){m=b.idx;var L=b.vm._update(C.data,e,R)}else var L=nn(C.view,C.data,C.key,C.opts)._redraw(e,R,!1);D=L.node.type}else if(D===r){var M=_(C.vm),L=C.vm._update(C.data,e,R,M);D=L.node.type}}if(null!=b&&(m===x?++x===d&&u>d&&(b=null,p=!1):w=!0,!y&&d>100&&w&&++k%10==0))for(;x<d&&sn(a[x]);)x++}c&&(e.body=A);h&&function(n,e){var t=e.body,l=n.el,r=n.body,i={lftNode:r[0],rgtNode:r[r.length-1],lftSib:(t[0]||f).el,rgtSib:(t[t.length-1]||f).el};n:for(;;){for(;;){var o=un(n,l,r,i,null,!1);if(o===ln)break;if(o===rn)break n}for(;;){var u=an(n,l,r,i,i.lftNode,!1);if(u===ln)break;if(u===rn)break n}fn(n,l,r,i);break}}(e,i)}(i,o):c!==a&&(null!=c?u.textContent=c:q(o)):y?(q(o),en(i)):c!==a&&(null!=c&&null!=a?u.firstChild.nodeValue=c:u.textContent=c),U(o.hooks,"didRecycle",o,i)}else u.nodeValue=c}function hn(n,e,t,l){var r=this;r.view=n,r.data=e,r.key=t,l&&(r.opts=l,r.config(l));var i=c(n)?n:n.call(r,r,e,t,l);v(i)?r.render=i:(r.render=i.render,r.config(i)),r._redrawAsync=g(function(n){return r.redraw(!0)}),r._updateAsync=g(function(n){return r.update(n,!0)}),r.init&&r.init.call(r,r,r.data,r.key,l)}hn.prototype={constructor:hn,_diff:null,init:null,view:null,key:null,data:null,state:null,api:null,opts:null,node:null,hooks:null,onevent:s,refs:null,render:null,mount:function(n,e){e?(q({el:n,flags:0}),this._redraw(null,null,!1),n.nodeName.toLowerCase()!==this.node.tag?(tn(this.node),z(n.parentNode,this.node.el,n),n.parentNode.removeChild(n)):z(n.parentNode,tn(this.node,n),n)):(this._redraw(null,null),n&&z(n,this.node.el));n&&O(this);return this},unmount:function(n){var e=this.node;F(e.el.parentNode,e.el),n||O(this)},config:function(n){n.init&&(this.init=n.init),n.diff&&(this.diff=n.diff),n.onevent&&(this.onevent=n.onevent),n.hooks&&(this.hooks=y(this.hooks||{},n.hooks))},parent:function(){return x(this.node.parent)},root:function(){for(var n=this.node;n.parent;)n=n.parent;return n.vm},redraw:function(n){null==n&&(n=X);return n?this._redraw(null,null,_(this)):this._redrawAsync(),this},update:function(n,e){null==e&&(e=X);return e?this._update(n,null,null,_(this)):this._updateAsync(n),this},_update:function(n,e,t,l){null!=n&&this.data!==n&&(U(this.hooks,"willUpdate",this,n),this.data=n);return this._redraw(e,t,l)},_redraw:function(n,e,t){var l,r,i=null==n,o=this.node&&this.node.el&&this.node.el.parentNode,u=this.node;if(null!=this.diff&&(l=this._diff,this._diff=r=this.diff(this,this.data),null!=u)){var a=d(l)?p:h,f=l===r||a(l,r);if(f)return pn(this,u,n,e)}o&&U(this.hooks,"willRedraw",this,this.data);var s=this.render.call(this,this,this.data,l,r);if(s===u)return pn(this,u,n,e);this.refs=null,null!=this.key&&s.key!==this.key&&(s.key=this.key);this.node=s,n?(I(s,n,e,this),n.body[e]=s):u&&u.parent?(I(s,u.parent,u.idx,this),u.parent.body[u.idx]=s):I(s,null,null,this);if(!1!==t)if(u)if(u.tag!==s.tag||u.key!==s.key){u.vm=s.vm=null;var c=u.el.parentNode,v=Y(u.el);F(c,u.el),z(c,tn(s),v),u.el=s.el,s.vm=this}else yn(s,u);else tn(s);o&&U(this.hooks,"didRedraw",this,this.data),i&&o&&O(this);return this},_redrawAsync:null,_updateAsync:null};function pn(n,e,t,l){return null!=t&&(t.body[l]=e,e.idx=l,e.parent=t,e._lis=!1),n}function gn(n,e,t,l){var r,i;return null==t?c(e)?r=e:i=e:(r=e,i=t),D(n,r,i,l)}var bn="http://www.w3.org/2000/svg";function mn(n,e,t,l){this.view=n,this.data=e,this.key=t,this.opts=l}mn.prototype={constructor:mn,type:l,view:null,data:null,key:null,opts:null};function kn(n){this.vm=n}kn.prototype={constructor:kn,type:r,vm:null};var _n={config:function(n){K=n.onevent||K,null!=n.syncRedraw&&(X=n.syncRedraw)},ViewModel:hn,VNode:N,createView:nn,defineElement:gn,defineSvgElement:function(n,e,t,l){var r=gn(n,e,t,l);return r.ns=bn,r},defineText:R,defineComment:function(n){var e=new N;return e.type=t,e.body=n,e},defineView:function(n,e,t,l){return new mn(n,e,t,l)},injectView:function(n){return new kn(n)},injectElement:function(e){var t=new N;return t.type=n,t.el=t.key=e,t},lazyList:function(n,e){var t=n.length,l={items:n,length:t,key:function(t){return e.key(n[t],t)},diff:function(t,l){var r=e.diff(n[t],t);if(null==l)return r;var i=l._diff;return(r===i||d(i)?p(r,i):h(r,i))||r},tpl:function(t){return e.tpl(n[t],t)},map:function(n){return e.tpl=n,l},body:function(n){for(var e=Array(t),r=0;r<t;r++){var i=l.tpl(r);i._diff=l.diff(r),e[r]=i,I(i,n,r)}n.body=e}};return l},FIXED_BODY:V,DEEP_REMOVE:C,KEYED_LIST:j,LAZY_LIST:T};return A.patch=function(n,e){!function(n,e,t){if(null!=e.type){if(null!=n.vm)return;I(e,n.parent,n.idx,null),n.parent.body[n.idx]=e,yn(e,n),t&&k(e),O(x(e))}else{var l=Object.create(n);l.attrs=y({},n.attrs);var r=y(n.attrs,e);if(null!=n._class){var i=r.class;r.class=null!=i&&""!==i?n._class+" "+i:n._class}$(n,l),t&&k(n)}}(this,n,e)},_n});